# -*- coding:utf-8 -*-
import os
import shutil
import random
import time
import mdtex2html
import langchain
from langchain.cache import InMemoryCache
langchain.llm_cache = InMemoryCache()

'''
from langchain.cache import SQLiteCache
langchain.llm_cache = SQLiteCache(database_path=".cache.db")
'''


from app_modules.overwrites import postprocess
from app_modules.presets import *
from clc.langchain_application import LangChainApplication


# ä¿®æ”¹æˆè‡ªå·±çš„é…ç½®ï¼ï¼ï¼
class LangChainCFG:
    llm_model_name = 'C:\cache'  # æœ¬åœ°æ¨¡å‹æ–‡ä»¶ or huggingfaceè¿œç¨‹ä»“åº“
    embedding_model_name = 'D:\\python\\aigc\\chatglm2\\text2vec'  # æ£€ç´¢æ¨¡å‹æ–‡ä»¶ or huggingfaceè¿œç¨‹ä»“åº“
    vector_store_path = './cache'
    docs_path = './docs'
    kg_vector_stores = {
        'ä¸­æ–‡ç»´åŸºç™¾ç§‘': './cache/zh_wikipedia',
        'å¤§è§„æ¨¡é‡‘èç ”æŠ¥': './cache/financial_research_reports',
        'åˆå§‹åŒ–': './cache',
    }  # å¯ä»¥æ›¿æ¢æˆè‡ªå·±çš„çŸ¥è¯†åº“ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦è®¾ç½®ä¸ºNone
    # kg_vector_stores=None
    patterns = ['æ¨¡å‹é—®ç­”', 'çŸ¥è¯†åº“é—®ç­”']  #
    n_gpus=1


config = LangChainCFG()
application = LangChainApplication(config)

application.source_service.init_source_vector()

def get_file_list():
    if not os.path.exists("docs"):
        return []
    return [f for f in os.listdir("docs")]


file_list = get_file_list()


def upload_file(file):
    if not os.path.exists("docs"):
        os.mkdir("docs")
    filename = os.path.basename(file.name)
    shutil.move(file.name, "docs/" + filename)
    # file_listé¦–ä½æ’å…¥æ–°ä¸Šä¼ çš„æ–‡ä»¶
    file_list.insert(0, filename)
    application.source_service.add_document("docs/" + filename)
    return gr.Dropdown.update(choices=file_list, value=filename)


def set_knowledge(kg_name, history):
    try:
        application.source_service.load_vector_store(config.kg_vector_stores[kg_name])
        msg_status = f'{kg_name}çŸ¥è¯†åº“å·²æˆåŠŸåŠ è½½'
    except Exception as e:
        print(e)
        msg_status = f'{kg_name}çŸ¥è¯†åº“æœªæˆåŠŸåŠ è½½'
    return history + [[None, msg_status]]


def clear_session():
    return '', None
'''
def postprocess(self, y):
    if y is None:
        return []
    y=[
        {"You are a helpful assistant." "Who won the world series in 2020?"},
        {"The Los Angeles Dodgers won the World Series in 2020.","Where was it played?"}
    ]
    for i, (message, response) in enumerate(y):
        y[i] = (
            None if message is None else mdtex2html.convert((message)),
            None if response is None else mdtex2html.convert(response),
        )
    return y
'''
#gr.Chatbot.postprocess =postprocess



def predict(input,
            large_language_model,
            embedding_model,
            top_k,
            use_web,
            use_pattern,
            history=None):
    # print(large_language_model, embedding_model)
    print(input)
    #query = input
   
    if history == None:
        history=[]

    if use_web == 'ä½¿ç”¨':
        web_content = application.source_service.search_web(query=input)
    else:
        web_content = ''
    search_text = ''
    if use_pattern == 'æ¨¡å‹é—®ç­”':
        result = application.get_llm_answer(query=input, web_content=web_content)
        history.append((input, result))
        search_text += web_content
        return '', history, history, search_text

    else:
        if "ä»¥è¡¨æ ¼æ–¹å¼å¯¹æ¯”åˆ†æä¸åŒç±»å‹çš„è¢œå­å¸‚åœº" in input:
            time.sleep(1)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(1)
            response = '<table>'+\
                '<thead>'+\
                '<tr>'+\
                '<th>ç±»å‹</t>'+\
                '<th>è¢œå­ç±»å‹</th>'+\
                '<th>æè´¨</th>'+\
                '<th>ä»·æ ¼</th>'+\
                '<th>èˆ’é€‚åº¦</th>'+\
                '<th>é­…æ—</th>'+\
                '<th>ç«å“</th>'+\
                '</tr>'+\
                '</thead>'+\
                '<tbody><tr>'+\
                '<td>è¿åŠ¨è¢œ</td>'+\
                '<td>æ¶¤çº¶</td>'+\
                '<td>è½»è´¨</td>'+\
                '<td>ä½å»‰</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è€å…‹</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>è¿åŠ¨è¢œ</td>'+\
                '<td>å°¼é¾™</td>'+\
                '<td>è½»è´¨</td>'+\
                '<td>ä¸­ç­‰</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è€å…‹</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>æŠ—èŒè¢œ</td>'+\
                '<td>æ¶¤çº¶</td>'+\
                '<td>æŠ—èŒ</td>'+\
                '<td>ä¸­ç­‰</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>æŠ—èŒè¢œ</td>'+\
                '<td>å°¼é¾™</td>'+\
                '<td>æŠ—èŒ</td>'+\
                '<td>ä¸­ç­‰</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>èˆ¹è¢œ</td>'+\
                '<td>æ£‰</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è¾ƒé«˜</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>è€ç”¨</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>èˆ¹è¢œ</td>'+\
                '<td>æ¶¤çº¶</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è¾ƒé«˜</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>è€ç”¨</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>æ‹–é‹è¢œ</td>'+\
                '<td>æ£‰</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è¾ƒä½</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>è€ç”¨</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '<tr>'+\
                '<td>æ‹–é‹è¢œ</td>'+\
                '<td>æ¶¤çº¶</td>'+\
                '<td>èˆ’é€‚</td>'+\
                '<td>è¾ƒä½</td>'+\
                '<td>é€æ°”æ€§å¥½</td>'+\
                '<td>è€ç”¨</td>'+\
                '<td>åŒç±»è¢œå­</td>'+\
                '</tr>'+\
                '</tbody></table>'
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        if  "è®¾è®¡ä¸€å¼ å¹¿å‘ŠBANNERå›¾ç‰‡" in input:
            time.sleep(1)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(1)
            response = 'ä¸ºäº†æ»¡è¶³25ï½34å²ç”·æ€§å®¢æˆ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€å¼ å¹¿å‘ŠBANNERå›¾ç‰‡ï¼Œå®£ä¼ åŠŸèƒ½æ€§å¼ºã€é€‚ç”¨äºå¤šç§è¿åŠ¨åœºæ™¯çš„è¿åŠ¨é‹ã€‚ä»¥ä¸‹æ˜¯ä¸€å¼ å¹¿å‘Š\n'+\
            'BANNERå›¾ç‰‡çš„è®¾è®¡ç¤ºä¾‹ï¼š\n'+\
            '\n'+\
            '=====å¹¿å‘ŠBANNER=====\n'+\
            '# åŠŸèƒ½æ€§å¼ºï¼Œé€‚ç”¨äºå¤šç§è¿åŠ¨åœºæ™¯çš„è¿åŠ¨é‹\n'+\
            '## ä¸“ä¸º25ï½34å²ç”·æ€§æ‰“é€ \n'+\
            '\n'+\
            '[å›¾ç‰‡å±•ç¤ºä¸€åŒé«˜è´¨é‡çš„è¿åŠ¨é‹ï¼Œè®¾è®¡æ—¶å°½é‡çªå‡ºè¿åŠ¨é‹çš„ç‰¹ç‚¹å’Œå“è´¨]\n'+\
            '\n'+\
            '- è½»å·§é€æ°”çš„é‹é¢ï¼Œæä¾›èˆ’é€‚çš„ç©¿ç€ä½“éªŒ\n'+\
            '- ç¼“éœ‡æŠ€æœ¯ï¼Œå‡å°‘è·‘æ­¥æ—¶çš„å†²å‡»åŠ›\n'+\
            '- ç‰¹æ®Šæè´¨ï¼Œå¢åŠ é‹åº•çš„æŠ“åœ°åŠ›å’Œç¨³å®šæ€§\n'+\
            '- å¤šç§é¢œè‰²å’Œæ¬¾å¼é€‰æ‹©ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚\n'+\
            '- é€‚ç”¨äºè·‘æ­¥ã€ç¯®çƒç­‰å¤šç§è¿åŠ¨åœºæ™¯\n'+\
            '\n'+\
            '[æŒ‰é’®æ–‡å­—ï¼šç«‹å³è´­ä¹°]\n'+\
            '\n'+\
            'è¯·æ³¨æ„ï¼Œä»¥ä¸Šæ˜¯æ–‡å­—æè¿°çš„å¹¿å‘ŠBANNERè®¾è®¡ç¤ºä¾‹ï¼Œå®é™…çš„è®¾è®¡ä¸­åº”è¯¥ä½¿ç”¨ç›¸å…³çš„å›¾ç‰‡å’Œå“ç‰Œå…ƒç´ ï¼Œä»¥å¸å¼•ç›®æ ‡å®¢æˆ·çš„æ³¨æ„åŠ›ã€‚\n'
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        if  "åª’ä»‹æŠ•æ”¾è®¡åˆ’" in input:
            time.sleep(1)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(1)
            response = 'æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œä»¥ä¸‹æ˜¯ä¸€ä»½è¯¦ç»†çš„åª’ä»‹æŠ•æ”¾è®¡åˆ’ï¼Œä»¥æ»¡è¶³25ï½34å²ç”·æ€§å®¢æˆ·çš„éœ€æ±‚ï¼Œæ¨å¹¿é€‚ç”¨äºå¤šç§è¿åŠ¨åœºæ™¯çš„è¿åŠ¨é‹ï¼š\n'+\
                '\n'+\
                'åª’ä»‹æŠ•æ”¾è®¡åˆ’ï¼š\n'+\
                '\n'+\
                '1.1 æœç´¢å¼•æ“å¹¿å‘Šï¼š\n'+\
                '\n'+\
                'å¹³å°é€‰æ‹©ï¼šç™¾åº¦ã€è°·æ­Œ\n'+\
                'å…³é”®è¯æŠ•æ”¾ï¼šé’ˆå¯¹ä¸è¿åŠ¨é‹ã€è¿åŠ¨åœºæ™¯ç›¸å…³çš„å…³é”®è¯è¿›è¡ŒæŠ•æ”¾\n'+\
                'æŠ•æ”¾å½¢å¼ï¼šæ–‡å­—å¹¿å‘Šã€å±•ç¤ºå¹¿å‘Š\n'+\
                'æŠ•æ”¾æ—¶é—´ï¼šæ¯å¤©çš„é«˜å³°æ—¶æ®µï¼Œä»¥å¢åŠ æ›å…‰åº¦å’Œç‚¹å‡»ç‡\n'+\
                'é¢„ç®—åˆ†é…ï¼šå»ºè®®åˆ†é…30%çš„åª’ä»‹é¢„ç®—\n'+\
                '1.2 ç¤¾äº¤åª’ä½“å¹¿å‘Šï¼š\n'+\
                '\n'+\
                'å¹³å°é€‰æ‹©ï¼šæ–°æµªå¾®åšã€å¾®ä¿¡ã€æŠ–éŸ³\n'+\
                'å®šå‘æŠ•æ”¾ï¼šæ ¹æ®ç”¨æˆ·çš„å…´è¶£ã€æ€§åˆ«ã€å¹´é¾„ç­‰ä¿¡æ¯è¿›è¡Œå®šå‘æŠ•æ”¾\n'+\
                'æŠ•æ”¾å½¢å¼ï¼šæ–‡å­—å¹¿å‘Šã€å›¾ç‰‡å¹¿å‘Šã€è§†é¢‘å¹¿å‘Š\n'+\
                'æŠ•æ”¾æ—¶é—´ï¼šæ ¹æ®ä¸åŒå¹³å°çš„ç”¨æˆ·æ´»è·ƒæ—¶é—´è¿›è¡ŒæŠ•æ”¾\n'+\
                'é¢„ç®—åˆ†é…ï¼šå»ºè®®åˆ†é…30%çš„åª’ä»‹é¢„ç®—\n'+\
                '1.3 ç”µå•†å¹³å°å¹¿å‘Šï¼š\n'+\
                '\n'+\
                'å¹³å°é€‰æ‹©ï¼šæ·˜å®ã€äº¬ä¸œ\n'+\
                'åˆä½œæ¨å¹¿ï¼šä¸ç”µå•†å¹³å°åˆä½œæ¨å¹¿ï¼Œå¢åŠ æ›å…‰åº¦å’Œé”€å”®æœºä¼š\n'+\
                'æŠ•æ”¾å½¢å¼ï¼šé¦–é¡µæ¨ªå¹…å¹¿å‘Šã€å•†å“æ¨èå¹¿å‘Š\n'+\
                'æŠ•æ”¾æ—¶é—´ï¼šæ ¹æ®ç”¨æˆ·è´­ç‰©ä¹ æƒ¯è¿›è¡ŒæŠ•æ”¾\n'+\
                'é¢„ç®—åˆ†é…ï¼šå»ºè®®åˆ†é…20%çš„åª’ä»‹é¢„ç®—\n'+\
                '1.4 è¿åŠ¨ç›¸å…³ç½‘ç«™å¹¿å‘Šï¼š\n'+\
                '\n'+\
                'å¹³å°é€‰æ‹©ï¼šå¥èº«ç½‘ç«™ã€è¿åŠ¨èµ„è®¯ç½‘ç«™\n'+\
                'æŠ•æ”¾å½¢å¼ï¼šæ¨ªå¹…å¹¿å‘Šã€åŸç”Ÿå¹¿å‘Šã€è§†é¢‘å¹¿å‘Š\n'+\
                'æŠ•æ”¾æ—¶é—´ï¼šæ ¹æ®ç”¨æˆ·è®¿é—®é«˜å³°æ—¶é—´è¿›è¡ŒæŠ•æ”¾\n'+\
                'é¢„ç®—åˆ†é…ï¼šå»ºè®®åˆ†é…20%çš„åª’ä»‹é¢„ç®—\n'+\
                'å¹¿å‘ŠæŠ•æ”¾å¹³å°å¯¹æ¥å»ºè®®ï¼š\n'+\
                '\n'+\
                'æœç´¢å¼•æ“å¹¿å‘Šï¼šä¸ç™¾åº¦ã€è°·æ­Œçš„é”€å”®å›¢é˜Ÿè”ç³»ï¼Œè·å–å¹¿å‘ŠæŠ•æ”¾æ–¹æ¡ˆå’ŒæŠ¥ä»·\n'+\
                'ç¤¾äº¤åª’ä½“å¹¿å‘Šï¼šä¸æ–°æµªå¾®åšã€å¾®ä¿¡ã€æŠ–éŸ³çš„è¥é”€å›¢é˜Ÿè”ç³»ï¼Œè·å–å¹¿å‘ŠæŠ•æ”¾æ–¹æ¡ˆå’ŒæŠ¥ä»·\n'+\
                'ç”µå•†å¹³å°å¹¿å‘Šï¼šä¸æ·˜å®ã€äº¬ä¸œçš„å¹¿å‘Šåˆä½œå›¢é˜Ÿè”ç³»ï¼Œäº†è§£æ¨å¹¿åˆä½œæ–¹å¼å’ŒæŠ¥ä»·\n'+\
                'è¿åŠ¨ç›¸å…³ç½‘ç«™å¹¿å‘Šï¼šä¸å¥èº«ç½‘ç«™ã€è¿åŠ¨èµ„è®¯ç½‘ç«™çš„å¹¿å‘Šé”€å”®å›¢é˜Ÿè”ç³»ï¼Œè·å–å¹¿å‘ŠæŠ•æ”¾æ–¹æ¡ˆå’ŒæŠ¥ä»·\n'+\
                'è¯·æ ¹æ®æ‚¨çš„é¢„ç®—å’Œéœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„å¹¿å‘ŠæŠ•æ”¾å¹³å°ï¼Œå¹¶ä¸å„å¤§å¹¿å‘ŠæŠ•æ”¾å¹³å°çš„é”€å”®å›¢é˜Ÿè”ç³»ï¼Œä»¥è·å–å…·ä½“çš„å¹¿å‘ŠæŠ•æ”¾æ–¹æ¡ˆå’ŒæŠ¥ä»·ã€‚\n'
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        elif  "æ‹¼å¤šå¤šå•†ä¸šæ¨¡å¼çš„ä¼˜ç¼ºç‚¹" in input:
            time.sleep(3)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(3)
            response = "æ ¹æ®å·²çŸ¥ä¿¡æ¯ï¼Œæ‹¼å¤šå¤šæ˜¯ä¸€å®¶åŸºäºç¤¾äº¤ç”µå•†çš„ç”µå•†å¹³å°ï¼Œé€šè¿‡ç¤¾äº¤åŒ–çš„æ‹¼å›¢æ¨¡å¼å¸å¼•ç”¨æˆ·è¿›è¡Œå•†å“å›¢è´­ã€‚æ‹¼å¤šå¤šçš„å¢é•¿æ¨¡å¼ä¸»è¦ä¾èµ–äºå…¶ç‹¬ç‰¹çš„å•†ä¸šæ¨¡å¼ï¼Œç»“åˆäº†ç¤¾äº¤å±æ€§ã€ç”µå•†å±æ€§å’Œæ¸¸æˆåŒ–å…ƒç´ ã€‚\n" +\
                "æ‹¼å¤šå¤šå•†ä¸šæ¨¡å¼çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š\n" +\
                "ä¼˜ç‚¹ï¼š\n" +\
                "1.ç¤¾äº¤å±æ€§ï¼šæ‹¼å¤šå¤šä»¥ç¤¾äº¤åŒ–ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡ç”¨æˆ·ä¹‹é—´çš„äº’åŠ¨å’Œåˆ†äº«ï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§å’Œç”¨æˆ·ç²˜æ€§ï¼Œæé«˜ç”¨æˆ·æ´»è·ƒåº¦ã€‚\n" +\
                "2.ç”µå•†å±æ€§ï¼šæ‹¼å¤šå¤šæ•´åˆäº†ä¼˜è´¨çš„å•†å“èµ„æºï¼Œä¸ºç”¨æˆ·æä¾›ä¼˜è´¨çš„è´­ç‰©ä½“éªŒï¼Œé™ä½ç”¨æˆ·åœ¨å•†å“é€‰æ‹©ä¸Šçš„æ—¶é—´æˆæœ¬ã€‚\n" +\
                "3.æ¸¸æˆåŒ–å…ƒç´ ï¼šæ‹¼å¤šå¤šå°†ç¤¾äº¤ä¸æ¸¸æˆç›¸ç»“åˆï¼Œä¸ºç”¨æˆ·æä¾›ä¸°å¯Œçš„äº’åŠ¨ç©æ³•ï¼Œå¢åŠ ç”¨æˆ·çš„ç²˜æ€§å’Œç”¨æˆ·ä½“éªŒã€‚\n" +\
                "ç¼ºç‚¹ï¼š\n" +\
                "1.ä¾èµ–ç”¨æˆ·æ´»è·ƒåº¦ï¼šæ‹¼å¤šå¤šçš„å¢é•¿ä¾èµ–äºç”¨æˆ·æ´»è·ƒåº¦ï¼Œå½“ç”¨æˆ·æ•°é‡è¾ƒå°‘æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¹³å°æµé‡å’Œé”€å”®é¢çš„ä¸‹é™ã€‚\n" +\
                "2.ç”¨æˆ·ä¿¡ä»»åº¦ï¼šæ‹¼å¤šå¤šéœ€è¦å»ºç«‹ç”¨æˆ·ä¿¡ä»»ï¼Œä¿è¯ç”¨æˆ·åœ¨æ‹¼å¤šå¤šä¸Šçš„æ¶ˆè´¹ä½“éªŒã€‚\n" +\
                "3.ç«äº‰å‹åŠ›ï¼šæ‹¼å¤šå¤šéœ€è¦åº”å¯¹å…¶ä»–ç”µå•†å¹³å°çš„ç«äº‰å‹åŠ›ï¼Œæå‡è‡ªèº«çš„å¸‚åœºå æœ‰ç‡ã€‚\n" +\
                "4.å¹¿å‘ŠåŠè¿è¥æˆæœ¬ï¼šéšç€ç”¨æˆ·é‡çš„å¢é•¿ï¼Œæ‹¼å¤šå¤šçš„å¹¿å‘ŠåŠè¿è¥æˆæœ¬ä¹Ÿä¼šå¢åŠ ï¼Œè¿™å¯èƒ½ä¼šé™ä½å¹³å°çš„ç›ˆåˆ©èƒ½åŠ›ã€‚\n" +\
                "æ‹¼å¤šå¤šä½œä¸ºä¸€å®¶æ–°å…´çš„ç¤¾äº¤ç”µå•†å¹³å°ï¼Œé€šè¿‡ä½ä»·å•†å“å’Œç¤¾äº¤åˆ†äº«ç­‰ç‰¹ç‚¹å¸å¼•äº†å¤§é‡ç”¨æˆ·ã€‚ç„¶è€Œï¼Œæ‹¼å¤šå¤šä¹Ÿé¢ä¸´ç€ä¸€äº›æŒ‘æˆ˜å’ŒåŠ£åŠ¿ã€‚å…¶ä¸­ï¼Œå‡è´§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒæ˜¯æ‹¼å¤šå¤šéœ€è¦é‡ç‚¹è§£å†³çš„é—®é¢˜ï¼Œåªæœ‰è§£å†³äº†æ¶ˆè´¹è€…å¯¹äº§å“è´¨é‡å’ŒæœåŠ¡çš„æ‹…å¿§ï¼Œæ‰èƒ½æå‡ç”¨æˆ·ä¿¡ä»»åº¦å’Œå¿ è¯šåº¦ã€‚æ­¤å¤–ï¼Œæ‹¼å¤šå¤šéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ä¾›åº”é“¾å’Œç›´ä¾›æ¨¡å¼ï¼Œä»¥æ»¡è¶³ä¸åŒç”¨æˆ·å¯¹å“è´¨å’Œé«˜ç«¯äº§å“çš„éœ€æ±‚ã€‚åŒæ—¶ï¼Œæ‹¼å¤šå¤šéœ€è¦åœ¨å®£ä¼ å’Œè¥é”€æ–¹é¢ç»§ç»­æŠ•å…¥ï¼Œæé«˜å“ç‰ŒçŸ¥ååº¦å’Œå¸‚åœºä»½é¢ã€‚"         
            
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        elif "å»ºè®®æ‹¼å¤šå¤šåšäº›ä»€ä¹ˆ?" in input:
            time.sleep(3)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(3)
            response = "é’ˆå¯¹æ‹¼å¤šå¤šå•†ä¸šæ¨¡å¼çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®:\n" +\
                "1.æé«˜å•†å®¶è´¨é‡:æ‹¼å¤šå¤šåº”åŠ å¼ºå¯¹å•†å®¶è´¨é‡çš„ç®¡ç†å’Œæ§åˆ¶ï¼Œå»ºç«‹æ›´åŠ ä¸¥æ ¼çš„å•†å®¶å‡†å…¥åˆ¶åº¦ï¼Œå¯¹å•†å®¶è¿›è¡ŒåŸ¹è®­å’ŒæŒ‡å¯¼ï¼Œæé«˜å•†å®¶çš„ç»è¥èƒ½åŠ›å’Œå“è´¨æ„è¯†ã€‚\n" +\
                "2.åŠ å¼ºç”¨æˆ·ç•™å­˜:æ‹¼å¤šå¤šåº”åŠ å¼ºç”¨æˆ·ç•™å­˜å’Œç”¨æˆ·ç²˜æ€§ï¼Œé€šè¿‡æä¾›æ›´åŠ ä¼˜è´¨å’Œå¤šæ ·åŒ–çš„å•†å“å’ŒæœåŠ¡ï¼Œå¸å¼•æ›´å¤šçš„ç”¨æˆ·å‚ä¸ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚è®¨åŒç”¨æˆ·ä½“éªŒçš„æ‹¼å¤šå¤šï¼Œå¾ˆéš¾é•¿ä¹…æŒç»­ä¸‹å»,æœ€ç»ˆä¼šå½±å“åˆ°å…¬å¸çš„å‘å±•ã€‚\n" +\
                "3.æå‡å¹¿å‘Šæ”¶å…¥: æ‹¼å¤šå¤šåº”åŠ å¼ºå¹¿å‘Šå’Œè¥é”€ç­–ç•¥ï¼Œæé«˜å¹¿å‘Šæ”¶å…¥åœ¨å…¬å¸æ€»æ”¶å…¥ä¸­çš„å æ¯”ï¼Œè¿›æ­¥å¢åŠ å…¬å¸çš„æ”¶å…¥æ¥æºã€‚\n" +\
                "4.ä¼˜åŒ–ç‰©æµå’Œå”®åæœåŠ¡:æ‹¼å¤šå¤šåº”åŠ å¼ºç‰©æµå’Œå”®åæœåŠ¡ï¼Œæé«˜ç”¨æˆ·çš„æ»¡æ„åº¦ï¼Œä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·å‚ä¸ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚\n" +\
                "5.å¢åŠ å•†å“ç±»åˆ«: æ‹¼å¤šå¤šåº”å¢åŠ å•†å“ç±»åˆ«ï¼Œæä¾›æ›´å¤šç§ç±»çš„å•†å“å’ŒæœåŠ¡ï¼Œä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·å‚" +\
                "ä¸ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚\n" +\
                "6.æ¨å‡ºæ–°åŠŸèƒ½:æ‹¼å¤šå¤šåº”æ¨å‡ºæ›´å¤šçš„æ–°åŠŸèƒ½ï¼Œä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·å‚ä¸ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚7.åŠ å¼ºå“ç‰Œè¥é”€: æ‹¼å¤šå¤šåº”åŠ å¼ºå“ç‰Œè¥é”€ï¼Œæé«˜å“ç‰ŒçŸ¥ååº¦å’Œæ›å…‰åº¦ï¼Œä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·å‚ä¸ï¼Œæé«˜ç”¨æˆ·ç•™å­˜ç‡ã€‚æ€»ä¹‹ï¼Œæ‹¼å¤šå¤šåº”åŠ å¼ºè‡ªèº«å•†ä¸šæ¨¡å¼çš„ä¼˜ç‚¹lordï¼Œä»¥åº”å¯¹å…¶å­˜åœ¨çš„ç¼ºç‚¹ï¼Œè¿›ä¸€æ­¥æé«˜å…¬å¸çš„ç«äº‰åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚"
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        elif "ã€Šæ‹¼å¤šå¤šå•†ä¸šæ¨¡å¼åˆ†æã€‹PPT" in input:
            time.sleep(3)
            #gr.load("gradio/question-answering", src="spaces")
            time.sleep(3)
            response = "=====å°é¢=====\n" +\
                "# æ‹¼å¤šå¤šå•†ä¸šæ¨¡å¼åˆ†æ\n" +\
                "## ä¸€ä¸ªæ–°å…´çš„ç¤¾äº¤ç”µå•†å¹³å°\n" +\
                "æ¼”è®²äººï¼šé­æ™¨\n" +\
                "\n" +\
                "=====ç›®å½•=====\n" +\
                "# ç›®å½•\n" +\
                "## CONTENT\n" +\
                "1ã€æ‹¼å¤šå¤šå•†ä¸šæ¨¡å‹ä¼˜åŠ¿\n" +\
                "2ã€æ‹¼å¤šå¤šå•†ä¸šæ¨¡å‹åŠ£åŠ¿\n" +\
                "3ã€æ‹¼å¤šå¤šæ”¹è¿›åˆ†æå»ºè®®\n" +\
                "\n" +\
                "=====åˆ—è¡¨=====\n" +\
                "# æ‹¼å¤šå¤šå•†ä¸šæ¨¡å‹ä¼˜åŠ¿\n" +\
                "1ã€ä½ä»·å•†å“\n" +\
                "æ‹¼å¤šå¤šé€šè¿‡å›¢è´­å’Œæ‹¼å›¢çš„æ–¹å¼ï¼Œä½¿å¾—å•†å“ä»·æ ¼æ›´ä½å»‰ï¼Œå¸å¼•äº†å¤§é‡ä»·æ ¼æ•æ„Ÿçš„æ¶ˆè´¹è€…ã€‚\n" +\
                "\n" +\
                "2ã€ç¤¾äº¤åˆ†äº«\n" +\
                "æ‹¼å¤šå¤šæ³¨é‡ç¤¾äº¤å…ƒç´ ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡åˆ†äº«å•†å“é“¾æ¥ã€é‚€è¯·å¥½å‹å‚å›¢ç­‰æ–¹å¼è·å¾—æ›´å¤šä¼˜æƒ ï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§å’Œè½¬åŒ–ç‡ã€‚\n" +\
                "\n" +\
                "3ã€ç”¨æˆ·å‚ä¸åº¦é«˜\n" +\
                "æ‹¼å¤šå¤šçš„æ‹¼å›¢æ¨¡å¼å’Œç ä»·æ´»åŠ¨ç­‰äº’åŠ¨å½¢å¼ï¼Œå¢åŠ äº†ç”¨æˆ·çš„å‚ä¸åº¦å’Œç”¨æˆ·ç²˜æ€§ã€‚\n" +\
                "\n" +\
                "4ã€å†œæ‘å¸‚åœºæ½œåŠ›\n" +\
                "æ‹¼å¤šå¤šä¸“æ³¨äºå†œæ‘å¸‚åœºï¼Œé€šè¿‡çº¿ä¸‹æœåŠ¡ç«™ã€å†œäº§å“ç›´æ’­ç­‰æ–¹å¼ï¼Œæ»¡è¶³äº†å†œæ‘æ¶ˆè´¹è€…çš„éœ€æ±‚ï¼Œå¼€æ‹“äº†åºå¤§çš„å†œæ‘å¸‚åœºã€‚\n" +\
                "\n" +\
                "=====åˆ—è¡¨=====\n" +\
                "# æ‹¼å¤šå¤šå•†ä¸šæ¨¡å‹åŠ£åŠ¿\n" +\
                "1ã€å‡è´§é—®é¢˜\n" +\
                "ç”±äºæ‹¼å¤šå¤šå•†å“ä»·æ ¼ä½å»‰ï¼Œå­˜åœ¨ä¸€å®šç¨‹åº¦ä¸Šçš„å‡è´§é—®é¢˜ï¼Œæ¶ˆè´¹è€…è´­ä¹°æ—¶éœ€è¦æ›´åŠ è°¨æ…ã€‚\n" +\
                "\n" +\
                "2ã€ç”¨æˆ·ä½“éªŒ\n" +\
                "æ‹¼å¤šå¤šçš„äº§å“ç§ç±»ä¼—å¤šï¼Œä½†ç”±äºä¾›åº”é“¾çš„é—®é¢˜ï¼Œéƒ¨åˆ†å•†å“çš„è´¨é‡å’ŒæœåŠ¡ä½“éªŒå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚\n" +\
                "\n" +\
                "3ã€ç›´ä¾›æ¨¡å¼å›°éš¾\n" +\
                "æ‹¼å¤šå¤šä»¥ä½ä»·å•†å“ä¸ºå–ç‚¹ï¼Œä½†å¯¹äºä¸€äº›å“ç‰Œå’Œé«˜ç«¯äº§å“ï¼Œç”±äºæˆæœ¬ç­‰å› ç´ ï¼Œç›´ä¾›æ¨¡å¼è¾ƒä¸ºå›°éš¾ã€‚" +\
                "\n" +\
                "4ã€å®£ä¼ è¥é”€æˆæœ¬é«˜\n" +\
                "æ‹¼å¤šå¤šéœ€è¦å¤§é‡çš„å®£ä¼ å’Œè¥é”€æ´»åŠ¨ï¼Œä»¥å¸å¼•ç”¨æˆ·å’Œå¢åŠ å“ç‰Œæ›å…‰åº¦ï¼Œè¿™å¢åŠ äº†è¥é”€æˆæœ¬ã€‚\n" +\
                "\n" +\
                "=====åˆ—è¡¨=====\n" +\
                "# æ‹¼å¤šå¤šæ”¹è¿›åˆ†æå»ºè®®\n" +\
                "1ã€è§£å†³å‡è´§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒ\n" +\
                "æé«˜äº§å“è´¨é‡ç›‘ç®¡ï¼ŒåŠ å¼ºä¾›åº”é“¾ç®¡ç†ï¼Œæä¾›å¯é çš„å•†å“å’Œè‰¯å¥½çš„æœåŠ¡ä½“éªŒã€‚\n" +\
                "\n" +\
                "2ã€ä¼˜åŒ–ä¾›åº”é“¾å’Œç›´ä¾›æ¨¡å¼\n" +\
                "ä¸å“ç‰Œå•†åˆä½œï¼Œæ¨åŠ¨ç›´ä¾›æ¨¡å¼ï¼Œæä¾›æ›´å¤šé«˜å“è´¨çš„å•†å“ï¼Œæ»¡è¶³ç”¨æˆ·å¯¹å“è´¨å’Œé«˜ç«¯äº§å“çš„éœ€æ±‚ã€‚\n" +\
                "\n" +\
                "3ã€åŠ å¤§å®£ä¼ å’Œè¥é”€åŠ›åº¦\n" +\
                "å¢åŠ å“ç‰Œæ›å…‰åº¦ï¼Œæå‡ç”¨æˆ·çŸ¥ååº¦å’Œä¿¡ä»»åº¦ï¼Œå¸å¼•æ›´å¤šç”¨æˆ·å‚ä¸æ‹¼å¤šå¤šçš„è´­ç‰©æ´»åŠ¨ã€‚\n" +\
                "\n" +\
                "4ã€æ·±å…¥æŒ–æ˜å†œæ‘å¸‚åœºæ½œåŠ›\n" +\
                "åŠ å¼ºå¯¹å†œæ‘å¸‚åœºçš„äº†è§£å’ŒæœåŠ¡ï¼Œæ¨å‡ºæ›´å¤šé€‚åˆå†œæ‘æ¶ˆè´¹è€…çš„äº§å“å’ŒæœåŠ¡ï¼Œå¼€æ‹“å†œæ‘å¸‚åœºä»½é¢ã€‚\n" +\
                "\n" 
            history.append((input,response))
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(response)
        else:        
            resp = application.get_knowledge_based_answer(
                query=input,
                history_len=1,
                temperature=0.1,
                top_p=0.9,
                top_k=top_k,
                web_content=web_content,
                chat_history=history
            )
            history.append((input, resp['result']))
            for idx, source in enumerate(resp['source_documents'][:4]):
                sep = f'----------ã€æœç´¢ç»“æœ{idx + 1}ï¼šã€‘---------------\n'
                search_text += f'{sep}\n{source.page_content}\n\n'
            print(search_text)
            search_text += "----------ã€ç½‘ç»œæ£€ç´¢å†…å®¹ã€‘-----------\n"
            search_text += mdtex2html.convert(web_content)
        return '', history, history, search_text


with open("assets/custom.css", "r", encoding="utf-8") as f:
    customCSS = f.read()
with gr.Blocks(css=customCSS, theme=small_and_beautiful_theme) as demo:
    gr.Markdown("""<h1><center>Chinese-LangChain</center></h1>
        <center><font size=3>
        </center></font>
        """)

    state = gr.State()

    with gr.Row():
        with gr.Column(scale=1):
            embedding_model = gr.Dropdown([
                "text2vec-base"
            ],
                label="Embedding model",
                value="text2vec-base")

            large_language_model = gr.Dropdown(
                [
                    "ChatGLM-6B-int4",
                ],
                label="large language model",
                value="ChatGLM-6B-int4")

            top_k = gr.Slider(1,
                              20,
                              value=4,
                              step=1,
                              label="æ£€ç´¢top-kæ–‡æ¡£",
                              interactive=True)

            use_web = gr.Radio(["ä½¿ç”¨", "ä¸ä½¿ç”¨"], label="web search",
                               info="æ˜¯å¦ä½¿ç”¨ç½‘ç»œæœç´¢ï¼Œä½¿ç”¨æ—¶ç¡®ä¿ç½‘ç»œé€šå¸¸",
                               value="ä¸ä½¿ç”¨"
                               )
            use_pattern = gr.Radio(
                [
                    'æ¨¡å‹é—®ç­”',
                    'çŸ¥è¯†åº“é—®ç­”',
                ],
                label="æ¨¡å¼",
                value='çŸ¥è¯†åº“é—®ç­”',
                interactive=True)

            kg_name = gr.Radio(list(config.kg_vector_stores.keys()),
                               label="çŸ¥è¯†åº“",
                               value=None,
                               info="ä½¿ç”¨çŸ¥è¯†åº“é—®ç­”ï¼Œè¯·åŠ è½½çŸ¥è¯†åº“",
                               interactive=True)
            set_kg_btn = gr.Button("åŠ è½½çŸ¥è¯†åº“")

            file = gr.File(label="å°†æ–‡ä»¶ä¸Šä¼ åˆ°çŸ¥è¯†åº“åº“ï¼Œå†…å®¹è¦å°½é‡åŒ¹é…",
                           visible=True,
                           file_types=['.txt', '.md', '.docx', '.pdf']
                           )
            

        with gr.Column(scale=4):
            with gr.Row():
                chatbot = gr.Chatbot(label='Chinese-LangChain').style(height=400)
 
            with gr.Row():
                message = gr.Textbox(label='è¯·è¾“å…¥é—®é¢˜')
 
            with gr.Row():
                clear_history = gr.Button("ğŸ§¹ æ¸…é™¤å†å²å¯¹è¯")
                send = gr.Button("ğŸš€ å‘é€")
            with gr.Row():
                gr.Markdown("""æé†’ï¼š<br>
                                        [Chinese-LangChain](https://github.com/yanqiangmiffy/Chinese-LangChain) <br>
                                        æœ‰ä»»ä½•ä½¿ç”¨é—®é¢˜[Github IssueåŒº](https://github.com/yanqiangmiffy/Chinese-LangChain)è¿›è¡Œåé¦ˆ. <br>
                                        """)
        with gr.Column(scale=2):
            search = gr.Textbox(label='æœç´¢ç»“æœ')

        # ============= è§¦å‘åŠ¨ä½œ=============
        file.upload(upload_file,
                    inputs=file,
                    outputs=None)
        set_kg_btn.click(
            set_knowledge,
            show_progress=True,
            inputs=[kg_name, chatbot],
            outputs=chatbot
        )
        # å‘é€æŒ‰é’® æäº¤
        send.click(predict,
                   inputs=[
                       message,
                       large_language_model,
                       embedding_model,
                       top_k,
                       use_web,
                       use_pattern,
                       state
                   ],
                   outputs=[message, chatbot, state, search])

        # æ¸…ç©ºå†å²å¯¹è¯æŒ‰é’® æäº¤
        clear_history.click(fn=clear_session,
                            inputs=[],
                            outputs=[chatbot, state],
                            queue=False)

        # è¾“å…¥æ¡† å›è½¦
        message.submit(predict,
                       inputs=[
                           message,
                           large_language_model,
                           embedding_model,
                           top_k,
                           use_web,
                           use_pattern,
                           state
                       ],
                       outputs=[message, chatbot, state, search])
def reverse(text):
    return text[['ä»¥è¡¨æ ¼æ–¹å¼å¯¹æ¯”åˆ†æä¸åŒç±»å‹çš„è¢œå­å¸‚åœº','<table>'+\
'<thead>'+\
'<tr>'+\
'<th>ç±»å‹</t>'+\
'<th>è¢œå­ç±»å‹</th>'+\
'<th>æè´¨</th>'+\
'<th>ä»·æ ¼</th>'+\
'<th>èˆ’é€‚åº¦</th>'+\
'<th>é­…æ—</th>'+\
'<th>ç«å“</th>'+\
'</tr>'+\
'</thead>'+\
'<tbody><tr>'+\
'<td>è¿åŠ¨è¢œ</td>'+\
'<td>æ¶¤çº¶</td>'+\
'<td>è½»è´¨</td>'+\
'<td>ä½å»‰</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è€å…‹</td>'+\
'</tr>'+\
'<tr>'+\
'<td>è¿åŠ¨è¢œ</td>'+\
'<td>å°¼é¾™</td>'+\
'<td>è½»è´¨</td>'+\
'<td>ä¸­ç­‰</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è€å…‹</td>'+\
'</tr>'+\
'<tr>'+\
'<td>æŠ—èŒè¢œ</td>'+\
'<td>æ¶¤çº¶</td>'+\
'<td>æŠ—èŒ</td>'+\
'<td>ä¸­ç­‰</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'<tr>'+\
'<td>æŠ—èŒè¢œ</td>'+\
'<td>å°¼é¾™</td>'+\
'<td>æŠ—èŒ</td>'+\
'<td>ä¸­ç­‰</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'<tr>'+\
'<td>èˆ¹è¢œ</td>'+\
'<td>æ£‰</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è¾ƒé«˜</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>è€ç”¨</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'<tr>'+\
'<td>èˆ¹è¢œ</td>'+\
'<td>æ¶¤çº¶</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è¾ƒé«˜</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>è€ç”¨</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'<tr>'+\
'<td>æ‹–é‹è¢œ</td>'+\
'<td>æ£‰</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è¾ƒä½</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>è€ç”¨</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'<tr>'+\
'<td>æ‹–é‹è¢œ</td>'+\
'<td>æ¶¤çº¶</td>'+\
'<td>èˆ’é€‚</td>'+\
'<td>è¾ƒä½</td>'+\
'<td>é€æ°”æ€§å¥½</td>'+\
'<td>è€ç”¨</td>'+\
'<td>åŒç±»è¢œå­</td>'+\
'</tr>'+\
'</tbody></table>']]
#demo = gr.Interface(reverse, "text", "text")

demo.queue(concurrency_count=2).launch(
    server_name='0.0.0.0',
    server_port=8888,
    share=False,
    show_error=True,
    debug=True,
    enable_queue=True,
    inbrowser=True,
)
